<template>
    <div class="gallery">
      <ul class="cards">
        <!-- Raccolta autorizzata -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/servizio1.jpg"
            alt="Servizio 1"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Raccolta autorizzata
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/chart-bar.svg" alt="chart bar" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Il pi√π efficace</p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/awards.svg" alt="Awards" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Da anni top leader</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Bonifica ambienti -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/bonifica-ambienti.jpg"
            alt="Bonifica ambienti"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Bonifica ambienti
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/sparkles.svg" alt="Sparkles" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Pulizia a fondo</p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/soap.svg" alt="Soap" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Massima igiene</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Linea meccanica ad aghi -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/linea-meccanica.jpg"
            alt="Linea meccanica"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Linea meccanica ad aghi
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/time.svg" alt="Time" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">
                  Effetto a lunga durata
                </p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/database.svg" alt="Database" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Economico</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Nebulizzatore zanzare -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/nebulizzatore-zanzare.jpg"
            alt="Nebulizzatore zanzare"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Nebulizzatore zanzare
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/plus.svg" alt="Plus" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">
                  Disinfestazione garantita
                </p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/circle.svg" alt="Circle" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Definitiva</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Falco elettronico -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/falco-elettronico.jpg"
            alt="Falco elettronico"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Falco elettronico
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/award-fill.svg" alt="Award fill" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Rivoluzionario</p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/update.svg" alt="Update" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Sostenibile</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Reti anti-intrusione -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/reti-anti-intrusione.jpg"
            alt="Reti anti-intrusione"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Reti anti-intrusione
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/bookmark.svg" alt="Bookmark" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Tradizionale</p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/check-yes.svg" alt="Check yes" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Intervento sicuro</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Linea elettrificata -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/linea-elettrificata.jpg"
            alt="Linea elettrificata"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Linea elettrificata
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/thumb-up.svg" alt="Thumb up" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">
                  Effetto a lunga durata
                </p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/circle.svg" alt="Circle" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Risultati garantiti</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Filo ballerino -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/filo-ballerino.jpg"
            alt="Filo ballerino"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Filo ballerino
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/bolt.svg" alt="Bolt" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Servizio veloce</p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/circle.svg" alt="Circle" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Intervento sicuro</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
  
        <!-- Falconiere autorizzato -->
        <li
          class="max-w-sm rounded-[12px] overflow-hidden shadow-lg m-5 bg-white"
        >
          <img
            class="w-full"
            src="../../assets/img/falconiere-autorizzato.jpg"
            alt="Falconiere autorizzato"
          />
          <div class="px-6 py-4 mt-9">
            <div class="font-bold text-black text-[24px] mb-2">
              Falconiere autorizzato
            </div>
            <p class="text-grey-3 font-paragraph text-p2">
              Qorem ipsum dolor sit amet, consectetur adipiscing elit.
            </p>
            <img class="mt-4" src="../../assets/img/line.svg" alt="Line" />
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/bolt.svg" alt="Bolt" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Servizio veloce</p>
              </div>
            </div>
  
            <div class="flex flex-row gap-2 mt-4">
              <div>
                <img src="../../assets/img/circle.svg" alt="Circle" />
              </div>
              <div>
                <p class="text-grey-3 text-p2 font-title">Intervento sicuro</p>
              </div>
            </div>
  
            <div class="mt-9 flex items-center">
              <div>
                <p class="text-green-mid-4 text-p2 font-title">
                  Scopri il servizio
                </p>
              </div>
  
              <div class="ml-2">
                <img
                  src="../../assets/img/arrow-right-green.svg"
                  alt="Arrow right green"
                />
              </div>
            </div>
          </div>
        </li>
      </ul>
  
      <div class="actions">
        <button class="prev">Prev</button>
        <button class="next">Next</button>
      </div>
    </div>
  
    <div class="drag-proxy"></div>
  </template>
  
  <script setup>
  import { gsap } from 'gsap';
  import { onMounted, ref } from 'vue';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { Draggable } from 'gsap/all';
  
  onMounted(() => {
    gsap.registerPlugin(ScrollTrigger, Draggable);
    let iteration = 0;
    gsap.set('.cards li', { xPercent: 400, opacity: 0, scale: 0 });
  
    const spacing = 0.1,
      snapTime = gsap.utils.snap(spacing),
      cards = gsap.utils.toArray('.cards li'),
      animateFunc = (element) => {
        const tl = gsap.timeline();
        tl.fromTo(
          element,
          { scale: 0, opacity: 0 },
          {
            scale: 1,
            opacity: 1,
            zIndex: 100,
            duration: 0.5,
            yoyo: true,
            repeat: 1,
            ease: 'power1.in',
            immediateRender: false,
          }
        ).fromTo(
          element,
          { xPercent: 400 },
          { xPercent: -400, duration: 1, ease: 'none', immediateRender: false },
          0
        );
        return tl;
      },
      seamlessLoop = buildSeamlessLoop(cards, spacing, animateFunc),
      playhead = { offset: 0 },
      wrapTime = gsap.utils.wrap(0, seamlessLoop.duration()),
      scrub = gsap.to(playhead, {
        // we reuse this tween to smoothly scrub the playhead on the seamlessLoop
        offset: 0,
        onUpdate() {
          seamlessLoop.time(wrapTime(playhead.offset)); // convert the offset to a "safe" corresponding time on the seamlessLoop timeline
        },
        duration: 0.5,
        ease: 'power3',
        paused: true,
      }),
      trigger = ScrollTrigger.create({
        start: 0,
        onUpdate(self) {
          let scroll = self.scroll();
          if (scroll > self.end - 1) {
            wrap(1, 2);
          } else if (scroll < 1 && self.direction < 0) {
            wrap(-1, self.end - 2);
          } else {
            scrub.vars.offset =
              (iteration + self.progress) * seamlessLoop.duration();
            scrub.invalidate().restart();
          }
        },
        end: '+=3000',
        pin: '.gallery',
      }),
      progressToScroll = (progress) =>
        gsap.utils.clamp(
          1,
          trigger.end - 1,
          gsap.utils.wrap(0, 1, progress) * trigger.end
        ),
      wrap = (iterationDelta, scrollTo) => {
        iteration += iterationDelta;
        trigger.scroll(scrollTo);
        trigger.update();
      };
    ScrollTrigger.addEventListener('scrollEnd', () =>
      scrollToOffset(scrub.vars.offset)
    );
  
    function scrollToOffset(offset) {
      let snappedTime = snapTime(offset),
        progress =
          (snappedTime - seamlessLoop.duration() * iteration) /
          seamlessLoop.duration(),
        scroll = progressToScroll(progress);
      if (progress >= 1 || progress < 0) {
        return wrap(Math.floor(progress), scroll);
      }
      trigger.scroll(scroll);
    }
  
    document
      .querySelector('.next')
      .addEventListener('click', () =>
        scrollToOffset(scrub.vars.offset + spacing)
      );
    document
      .querySelector('.prev')
      .addEventListener('click', () =>
        scrollToOffset(scrub.vars.offset - spacing)
      );
  
    function buildSeamlessLoop(items, spacing, animateFunc) {
      let rawSequence = gsap.timeline({ paused: true }),
        seamlessLoop = gsap.timeline({
          paused: true,
          repeat: -1,
          onRepeat() {
            this._time === this._dur && (this._tTime += this._dur - 0.01);
          },
          onReverseComplete() {
            this.totalTime(this.rawTime() + this.duration() * 100);
          },
        }),
        cycleDuration = spacing * items.length,
        dur;
  
      items
        .concat(items)
        .concat(items)
        .forEach((item, i) => {
          let anim = animateFunc(items[i % items.length]);
          rawSequence.add(anim, i * spacing);
          dur || (dur = anim.duration());
        });
  
      seamlessLoop.fromTo(
        rawSequence,
        {
          time: cycleDuration + dur / 2,
        },
        {
          time: '+=' + cycleDuration,
          duration: cycleDuration,
          ease: 'none',
        }
      );
      return seamlessLoop;
    }
  
    Draggable.create('.drag-proxy', {
      type: 'x',
      trigger: '.cards',
      onPress() {
        this.startOffset = scrub.vars.offset;
      },
      onDrag() {
        scrub.vars.offset = this.startOffset + (this.startX - this.x) * 0.001;
        scrub.invalidate().restart();
      },
      onDragEnd() {
        scrollToOffset(scrub.vars.offset);
      },
    });
  });
  </script>
  
  <style>
  .gallery {
    width: 100%;
    height: 100vh;
    overflow: hidden;
  }
  
  .cards {
    width: 14rem;
    height: 18rem;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .cards li {
    list-style: none;
    padding: 0;
    margin: 0;
    width: 14rem;
    height: 18rem;
    text-align: center;
    line-height: 18rem;
    font-size: 2rem;
    top: 0;
    left: 0;
    border-radius: 0.8rem;
  }
  
  .actions {
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
  }
  
  .drag-proxy {
    visibility: hidden;
  }
  </style>
  